name: Auto Sync Fork and Releases

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync-fork-and-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä½ çš„ Fork ä»“åº“
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 2ï¼šè®¾ç½® Git èº«ä»½
      - name: Set up Git Identity
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      # æ­¥éª¤ 3ï¼šå®‰è£… GitHub CLI
      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      # æ­¥éª¤ 4ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“
      - name: Add Upstream Remote
        run: |
          git remote add upstream https://github.com/MoonTechLab/Selene.git || true
          git fetch upstream --tags -f

      # æ­¥éª¤ 5ï¼šåŒæ­¥å®‰å…¨çš„ Tags
      - name: Sync Safe Tags
        run: |
          # è·å–ä¸Šæ¸¸æ‰€æœ‰ Tags
          UPSTREAM_TAGS=$(git ls-remote --tags upstream | awk -F/ '{print $3}' | sort -V)
          
          echo "ä¸Šæ¸¸ Tags:"
          echo "$UPSTREAM_TAGS"
          
          # é€ä¸ªæ£€æŸ¥å¹¶æ¨é€å®‰å…¨çš„ Tags
          for TAG in $UPSTREAM_TAGS; do
            # æ£€æŸ¥è¯¥ Tag æ˜¯å¦åŒ…å« .github/workflows/ æ–‡ä»¶
            if git diff --quiet $TAG -- .github/workflows/ 2>/dev/null; then
              echo "âœ… æ¨é€å®‰å…¨çš„ Tag: $TAG"
              git push origin "refs/tags/$TAG" 2>/dev/null || echo "â„¹ï¸ Tag å¯èƒ½å·²å­˜åœ¨: $TAG"
            else
              echo "âŒ è·³è¿‡ Tag $TAGï¼ˆåŒ…å« workflow æ–‡ä»¶ï¼‰"
            fi
          done

      # æ­¥éª¤ 6ï¼šå½»åº•æ¸…ç†å¹¶å¼ºåˆ¶åŒæ­¥ Release
      - name: Force Sync Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æ‰€æœ‰æœ¬åœ° Tags
          LOCAL_TAGS=$(git tag -l | sort -V)
          
          echo "æœ¬åœ° Tags:"
          echo "$LOCAL_TAGS"
          
          for TAG in $LOCAL_TAGS; do
            echo "=== å½»åº•å¤„ç† Tag: $TAG ==="
            
            # æ£€æŸ¥ä¸Šæ¸¸ Release ä¿¡æ¯
            UPSTREAM_URL="https://api.github.com/repos/MoonTechLab/Selene/releases/tags/$TAG"
            UPSTREAM_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$UPSTREAM_URL")
            
            # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰è¯¥ Release
            UPSTREAM_EXISTS=$(echo "$UPSTREAM_RESPONSE" | jq -r '.id' | grep -v null || echo "")
            
            if [ -z "$UPSTREAM_EXISTS" ]; then
              echo "âŒ ä¸Šæ¸¸æ²¡æœ‰ Tag $TAG çš„ Release"
              continue
            fi

            # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰ Assets
            UPSTREAM_ASSETS_COUNT=$(echo "$UPSTREAM_RESPONSE" | jq -r '.assets | length')
            if [ "$UPSTREAM_ASSETS_COUNT" -eq 0 ]; then
              echo "â„¹ï¸ ä¸Šæ¸¸ Release æ²¡æœ‰ Assets: $TAG"
              continue
            fi

            echo "âœ… å‘ç°ä¸Šæ¸¸ Assets ($UPSTREAM_ASSETS_COUNT ä¸ª): $TAG"
            
            # æ–¹æ³•1ï¼šä½¿ç”¨ API å½»åº•æ£€æŸ¥å¹¶åˆ é™¤ Release
            echo "ğŸ” æ£€æŸ¥ Release çŠ¶æ€..."
            LOCAL_RELEASE_URL="https://api.github.com/repos/$GITHUB_REPOSITORY/releases/tags/$TAG"
            LOCAL_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$LOCAL_RELEASE_URL")
            LOCAL_RELEASE_ID=$(echo "$LOCAL_RESPONSE" | jq -r '.id' | grep -v null || echo "")
            
            if [ -n "$LOCAL_RELEASE_ID" ]; then
              echo "ğŸ—‘ï¸ é€šè¿‡ API åˆ é™¤ Release: $TAG (ID: $LOCAL_RELEASE_ID)"
              curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/$GITHUB_REPOSITORY/releases/$LOCAL_RELEASE_ID" && \
                echo "âœ… API åˆ é™¤æˆåŠŸ" || echo "âŒ API åˆ é™¤å¤±è´¥"
            else
              echo "â„¹ï¸ é€šè¿‡ API æ£€æµ‹ Release ä¸å­˜åœ¨"
            fi

            # æ–¹æ³•2ï¼šä½¿ç”¨ gh CLI å†æ¬¡å°è¯•åˆ é™¤
            echo "ğŸ—‘ï¸ ä½¿ç”¨ gh CLI åˆ é™¤ Release: $TAG"
            gh release delete "$TAG" --yes 2>/dev/null && echo "âœ… gh åˆ é™¤æˆåŠŸ" || echo "â„¹ï¸ gh åˆ é™¤å¤±è´¥ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰"
            
            # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿åˆ é™¤å®Œæˆ
            sleep 2
            
            # å†æ¬¡æ£€æŸ¥ Release çŠ¶æ€
            echo "ğŸ” å†æ¬¡æ£€æŸ¥ Release çŠ¶æ€..."
            LOCAL_RESPONSE_AFTER=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$LOCAL_RELEASE_URL")
            LOCAL_RELEASE_ID_AFTER=$(echo "$LOCAL_RESPONSE_AFTER" | jq -r '.id' | grep -v null || echo "")
            
            if [ -n "$LOCAL_RELEASE_ID_AFTER" ]; then
              echo "âŒ Release ä»ç„¶å­˜åœ¨ï¼Œè·³è¿‡: $TAG"
              continue
            fi

            echo "âœ… Release ç¡®è®¤å·²åˆ é™¤: $TAG"
            
            # ä¸‹è½½ Assets
            mkdir -p "release_assets/$TAG"
            echo "$UPSTREAM_RESPONSE" | jq -r '.assets[].browser_download_url' | while read ASSET_URL; do
              if [ -n "$ASSET_URL" ]; then
                FILENAME="release_assets/$TAG/$(basename "$ASSET_URL")"
                echo "â¬‡ï¸ ä¸‹è½½: $(basename "$ASSET_URL")"
                curl -L -o "$FILENAME" "$ASSET_URL" && echo "âœ… ä¸‹è½½æˆåŠŸ" || echo "âŒ ä¸‹è½½å¤±è´¥"
              fi
            done

            # å¼ºåˆ¶åˆ›å»º Releaseï¼ˆä½¿ç”¨ API æ–¹æ³•ï¼‰
            if [ "$(ls -A release_assets/$TAG 2>/dev/null)" ]; then
              echo "ğŸš€ ä½¿ç”¨ API åˆ›å»º Release: $TAG"
              
              # åˆ›å»º Release æ•°æ®
              RELEASE_DATA=$(cat << EOF
{
  "tag_name": "$TAG",
  "name": "$TAG (Synced from Upstream)",
  "body": "Automatically synced from MoonTechLab/Selene",
  "draft": false,
  "prerelease": false
}
EOF
              )
              
              # åˆ›å»º Release
              RELEASE_RESPONSE=$(curl -s -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
                -d "$RELEASE_DATA")
              
              RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
              
              if [ "$RELEASE_ID" != "null" ]; then
                echo "âœ… API åˆ›å»º Release æˆåŠŸï¼ŒID: $RELEASE_ID"
                
                # ä¸Šä¼  Assets
                for ASSET_FILE in release_assets/$TAG/*; do
                  if [ -f "$ASSET_FILE" ]; then
                    ASSET_NAME=$(basename "$ASSET_FILE")
                    echo "â¬†ï¸ ä¸Šä¼  Asset: $ASSET_NAME"
                    
                    UPLOAD_RESPONSE=$(curl -s -X POST \
                      -H "Authorization: token $GITHUB_TOKEN" \
                      -H "Accept: application/vnd.github.v3+json" \
                      -H "Content-Type: application/octet-stream" \
                      "https://uploads.github.com/repos/$GITHUB_REPOSITORY/releases/$RELEASE_ID/assets?name=$ASSET_NAME" \
                      --data-binary @"$ASSET_FILE")
                    
                    UPLOAD_SUCCESS=$(echo "$UPLOAD_RESPONSE" | jq -r '.id' | grep -v null || echo "")
                    if [ -n "$UPLOAD_SUCCESS" ]; then
                      echo "âœ… ä¸Šä¼ æˆåŠŸ: $ASSET_NAME"
                    else
                      echo "âŒ ä¸Šä¼ å¤±è´¥: $ASSET_NAME"
                    fi
                  fi
                done
              else
                echo "âŒ API åˆ›å»º Release å¤±è´¥"
                echo "å“åº”: $RELEASE_RESPONSE"
              fi
            else
              echo "âŒ æ²¡æœ‰å¯ç”¨çš„ Assets æ–‡ä»¶"
            fi
            
            echo ""
          done

      # æ­¥éª¤ 7ï¼šæ¸…ç†å’ŒéªŒè¯
      - name: Cleanup and Verify
        run: |
          rm -rf release_assets
          echo "=== åŒæ­¥å®Œæˆ ==="
          echo "âœ… Tags æ•°é‡: $(git tag -l | wc -l)"
          echo "ğŸ“Š è¯·æ£€æŸ¥: https://github.com/$GITHUB_REPOSITORY/releases"
