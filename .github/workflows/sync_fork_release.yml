name: Auto Sync Fork and Releases

on:
  schedule:
    - cron: '0 2 * * *'  # 每天 UTC 2:00（北京时间 10:00）
  workflow_dispatch:     # 支持手动触发

jobs:
  sync-fork-and-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 步骤 1：检出你的 Fork 仓库
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 步骤 2：设置 Git 身份
      - name: Set up Git Identity
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      # 步骤 3：添加上游仓库并强制获取所有 Tags
      - name: Add Upstream Remote and Fetch Tags
        run: |
          git remote add upstream https://github.com/MoonTechLab/Selene.git || true
          git fetch upstream --tags -f

      # 步骤 4：调试 - 显示所有 Tags 信息
      - name: Debug Tags Information
        run: |
          echo "=== 本地 Tags ==="
          git tag -l | sort -V
          echo "=== 上游 Tags ==="
          git ls-remote --tags upstream | awk -F/ '{print $3}' | sort -V
          echo "=== 差异分析 ==="
          git tag -l | sort -V > local_tags.txt
          git ls-remote --tags upstream | awk -F/ '{print $3}' | sort -V > upstream_tags.txt
          echo "本地有但上游没有:"
          comm -23 local_tags.txt upstream_tags.txt || echo "无"
          echo "上游有但本地没有:"
          comm -13 local_tags.txt upstream_tags.txt || echo "无"

      # 步骤 5：同步所有 Tags（简化版）
      - name: Sync All Tags
        run: |
          # 直接推送所有上游 Tags（让 Git 自动处理冲突）
          git push origin --tags --force-if-includes

      # 步骤 6：检查并同步 Release Assets
      - name: Sync Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取上游所有 Tags
          UPSTREAM_TAGS=$(git ls-remote --tags upstream | awk -F/ '{print $3}' | sort -V)
          
          for TAG in $UPSTREAM_TAGS; do
            echo "处理 Tag: $TAG"
            
            # 检查本地是否已有该 Release
            EXISTING_RELEASE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$GITHUB_REPOSITORY/releases/tags/$TAG" | jq -r '.id')
            
            if [ "$EXISTING_RELEASE" != "null" ]; then
              echo "Release 已存在: $TAG"
              continue
            fi

            # 检查上游 Release 信息
            UPSTREAM_URL="https://api.github.com/repos/MoonTechLab/Selene/releases/tags/$TAG"
            echo "查询上游 API: $UPSTREAM_URL"
            
            RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$UPSTREAM_URL")
            echo "API 响应:"
            echo "$RESPONSE" | jq . || echo "JSON 解析失败，原始响应: $RESPONSE"

            # 检查是否有 Assets
            if echo "$RESPONSE" | jq -e '.assets? | length > 0' >/dev/null 2>&1; then
              echo "发现 Assets，开始下载: $TAG"
              mkdir -p "release_assets/$TAG"
              
              # 下载 Assets
              echo "$RESPONSE" | jq -r '.assets[].browser_download_url' | while read ASSET_URL; do
                if [ -n "$ASSET_URL" ]; then
                  echo "下载: $ASSET_URL"
                  curl -L -o "release_assets/$TAG/$(basename "$ASSET_URL")" "$ASSET_URL" || echo "下载失败: $ASSET_URL"
                fi
              done

              # 创建 Release
              echo "创建 Release: $TAG"
              if [ "$(ls -A release_assets/$TAG)" ]; then
                gh release create "$TAG" \
                  --title "$TAG (Synced from Upstream)" \
                  --notes "Automatically synced from MoonTechLab/Selene" \
                  "release_assets/$TAG/"* || echo "Release 创建失败"
              else
                echo "没有可用的 Assets 文件"
              fi
            else
              echo "Tag $TAG 没有 Assets 或 API 调用失败"
            fi
          done

      # 步骤 7：验证同步结果
      - name: Verify Sync Results
        run: |
          echo "=== 同步完成验证 ==="
          echo "本地 Tags:"
          git tag -l | sort -V
          echo "请检查 https://github.com/$GITHUB_REPOSITORY/tags 确认所有 Tags 已同步"
